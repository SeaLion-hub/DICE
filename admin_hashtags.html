<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DICE 관리자 - 세부 해시태그 추출</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        h1 { color: #003876; border-bottom: 2px solid #003876; padding-bottom: 10px; }
        h2 { margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px; }
        th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background-color: #003876; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        a { color: #003876; text-decoration: none; word-break: break-all; }
        a:hover { text-decoration: underline; }
        button { background-color: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; min-width: 80px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .result-span { 
            display: block; 
            margin-top: 8px; 
            font-style: italic; 
            color: #555; 
            font-size: 0.9em; 
            word-break: break-word;
        }
        .result-span.saved { color: #28a745; font-weight: bold; }
        .result-span.error { color: #dc3545; font-weight: bold; }
        #loading { font-weight: bold; color: #d9534f; }
        
        /* [수정] 4열 테이블에 맞게 너비 조정 */
        td:nth-child(1) { width: 12%; } /* 단과대 */
        td:nth-child(2) { width: 45%; } /* 제목 */
        td:nth-child(3) { width: 10%; } /* 대분류 */
        td:nth-child(4) { width: 33%; } /* 세부 해시태그 */
    </style>
</head>
<body>
    <h1>DICE 관리자 - 세부 해시태그 추출</h1>
    <h2><a href="/admin/dashboard_compare">➡️ 지원자격/적합도 테스트 페이지로 이동</a></h2>
    <h2><a href="/admin/dashboard_body">➡️ 본문 수정 페이지로 이동</a></h2>
    <p id="loading">공지사항 목록 로딩 중...</p>
    
    <table id="notices-table">
        <thead>
            <tr>
                <th>단과대</th>
                <th>제목 (링크)</th>
                <th>대분류</th>
                <th>세부 해시태그 (추출/저장)</th>
            </tr>
        </thead>
        <tbody id="notices-body">
            </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', loadNotices);

        // 1. 공지사항 목록 로드
        async function loadNotices() {
            try {
                // [수정] limit=1000 유지
                const response = await fetch('/admin/api/notices?limit=1000&sort_by=missing_tags'); 
                if (!response.ok) throw new Error('Failed to fetch notices');
                
                const data = await response.json();
                const tbody = document.getElementById('notices-body');
                tbody.innerHTML = ''; 

                if (data.items.length === 0) {
                     document.getElementById('loading').textContent = '세부 추출이 필요한 공지가 없습니다. (#일반 제외)';
                     return;
                }

                data.items.forEach(notice => {
                    const tr = document.createElement('tr');
                    
                    // (세부 해시태그)
                    const savedTags = notice.detailed_hashtags || [];
                    const hasSavedTags = savedTags.length > 0;
                    const buttonText = hasSavedTags ? '재추출' : '추출 실행';
                    const buttonColor = hasSavedTags ? '#ffc107' : '#007bff'; // 재추출은 노란색
                    
                    let savedTagsHtml = '';
                    if (hasSavedTags) {
                        savedTagsHtml = `<span class="result-span saved">(저장됨: ${escapeHTML(savedTags.join(', '))})</span>`;
                    } else {
                        savedTagsHtml = `<span class="result-span"></span>`;
                    }
                    
                    // [수정] 대분류(hashtags_ai)가 배열(List)이므로 join으로 표시
                    const mainCategoriesList = notice.hashtags_ai || [];
                    const mainCategoriesDisplay = mainCategoriesList.join(', ');
                    
                    // [수정] 버튼에 data- 속성으로 'main_categories' 리스트(JSON 문자열)를 저장
                    const mainCategoriesData = escapeHTML(JSON.stringify(mainCategoriesList));

                    tr.innerHTML = `
                        <td>${escapeHTML(notice.college_name)}</td>
                        <td><a href="${escapeHTML(notice.url)}" target="_blank" title="${escapeHTML(notice.url)}">${escapeHTML(notice.title)}</a></td>
                        
                        <td>${escapeHTML(mainCategoriesDisplay)}</td>
                        
                        <td id="cell-tag-${notice.id}">
                            <button style="background-color: ${buttonColor};" 
                                    data-hashtags-ai="${mainCategoriesData}" 
                                    onclick="extractTags('${notice.id}', this)">
                                ${buttonText}
                            </button>
                            ${savedTagsHtml}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('loading').textContent = `공지 ${data.items.length}개 로드 완료. (#일반 제외)`;

            } catch (error) {
                console.error('Error loading notices:', error);
                document.getElementById('loading').textContent = '공지 로드 실패.';
            }
        }

        // 2. [수정] 세부 해시태그 추출 및 저장 실행 (mainCategories 리스트 전달)
        async function extractTags(noticeId, buttonEl) {
            const cell = buttonEl.closest('td'); 
            const resultSpan = cell.querySelector('.result-span'); 
            
            // [수정] 버튼의 data- 속성에서 mainCategories 리스트(JSON)를 파싱
            let mainCategories;
            try {
                mainCategories = JSON.parse(buttonEl.dataset.hashtagsAi || '[]');
            } catch (e) {
                mainCategories = [];
            }

            // [신규] mainCategories가 비어있으면 실행 중지
            if (!mainCategories || mainCategories.length === 0) {
                resultSpan.textContent = '[오류: 대분류(hashtags_ai)가 비어있어 추출할 수 없습니다.]';
                resultSpan.className = 'result-span error';
                return;
            }
            
            buttonEl.disabled = true;
            buttonEl.textContent = '추출 중...';
            resultSpan.textContent = `(AI 추출 중... ${mainCategories.join(', ')})`;
            resultSpan.className = 'result-span'; 

            try {
                const response = await fetch('/admin/api/extract-detailed-hashtags', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // [수정] main_category -> main_categories (리스트 전달)
                    body: JSON.stringify({
                        notice_id: noticeId,
                        main_categories: mainCategories 
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || '추출 실패');
                }

                const data = await response.json();
                
                if (data.detailed_hashtags && data.detailed_hashtags.length > 0) {
                    resultSpan.textContent = `(저장됨: ${escapeHTML(data.detailed_hashtags.join(', '))})`;
                    resultSpan.className = 'result-span saved'; // 성공 스타일
                } else {
                    resultSpan.textContent = '[추출 결과 없음 (저장됨)]';
                    resultSpan.className = 'result-span';
                }
                
                buttonEl.textContent = '재추출';
                buttonEl.style.backgroundColor = '#28a745'; // 성공 시 초록색
                buttonEl.disabled = false;

            } catch (error) {
                console.error('Error extracting tags:', error);
                resultSpan.textContent = `[오류: ${error.message}]`;
                resultSpan.className = 'result-span error'; // 오류 스타일
                buttonEl.textContent = '추출 실패';
                buttonEl.style.backgroundColor = '#dc3545'; // 실패 시 빨간색
                buttonEl.disabled = false;
            }
        }

        // (Helper) HTML 태그 이스케이프
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            // [수정] JSON.stringify는 여기서 하면 안 됨. (데이터 속성용 문자열화는 위에서 이미 처리)
            if (typeof str === 'object') {
                 // 이스케이프 함수는 문자열만 처리해야 함.
                 // JSON.stringify(str, null, 2)
                 // mainCategoriesData를 만들 때 이미 JSON.stringify를 사용했으므로
                 // 이 함수는 순수 문자열만 받는다고 가정.
                 // 만약 객체가 들어오면 안전하게 문자열로 변환
                 try {
                     str = JSON.stringify(str);
                 } catch (e) {
                     str = String(str);
                 }
            }
            
            return String(str).replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }
    </script>
</body>
</html>