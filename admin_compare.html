<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DICE 관리자 - 지원자격 추출 및 적합도 테스트</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 2em auto; 
            background-color: #f4f4f9; 
            color: #333;
            max-width: 1600px;
            padding: 0 1em;
        }
        h1 { color: #003876; border-bottom: 2px solid #003876; padding-bottom: 10px; }
        h2 { margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px; }
        th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background-color: #003876; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        a { color: #003876; text-decoration: none; word-break: break-all; }
        a:hover { text-decoration: underline; }
        
        button { 
            background-color: #007bff; color: white; border: none; 
            padding: 8px 12px; border-radius: 4px; cursor: pointer; 
            font-size: 14px; min-width: 80px; margin-bottom: 5px;
            margin-right: 5px; /* [신규] 버튼 간격 */
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        button.extract-qual { background-color: #17a2b8; } 
        button.extract-qual:hover { background-color: #117a8b; }
        
        /* --- [신규] 날짜 추출 버튼 스타일 --- */
        button.extract-dates { background-color: #fd7e14; } /* 주황 */
        button.extract-dates:hover { background-color: #e66b00; }
        /* --------------------------------- */

        button.compare { background-color: #6f42c1; } 
        button.compare:hover { background-color: #5a359a; }
        
        pre {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.85em;
            word-break: break-all;
            white-space: pre-wrap;
            margin-top: 8px;
            max-height: 200px; 
            overflow-y: auto;
            color: #333;
        }
        .result-span { 
            display: block; 
            margin-top: 8px; 
            font-size: 0.9em; 
            word-break: break-word;
        }
        .result-span.loading { color: #fd7e14; }
        .result-span.error { color: #dc3545; font-weight: bold; }
        
        .result-span.eligible { color: #28a745; } 
        .result-span.borderline { color: #ffc107; } 
        .result-span.ineligible { color: #dc3545; } 
        
        /* --- [유지] 날짜 표시용 스타일 --- */
        .date-display {
            display: block;
            font-size: 0.85em;
            color: #555;
            margin-top: 6px;
            padding-left: 2px;
            font-family: 'SFMono-Regular', Consolas, 'Courier New', monospace;
        }
        .date-display.start-date { 
            color: #27ae60; 
        }
        .date-display.end-date { 
            font-weight: bold; 
            color: #c0392b; 
            margin-top: 3px;
        }
        /* ------------------------------- */
        
        #loading { font-weight: bold; color: #d9534f; }

        td:nth-child(1) { width: 10%; } 
        td:nth-child(2) { width: 30%; } 
        td:nth-child(3) { width: 8%; }  
        td:nth-child(4) { width: 26%; } /* 지원자격 (JSON) */
        td:nth-child(5) { width: 26%; } /* 적합도 비교 */
    </style>
</head>
<body>
    <h1>DICE 관리자 - 지원자격 추출 및 적합도 테스트</h1>
    <h2><a href="/admin/dashboard_hashtags">⬅️ 세부 해시태그 관리 페이지으로 이동</a></h2>
    <h2><a href="/admin/dashboard_body">➡️ 본문 수정 페이지로 이동</a></h2>
    <p id="loading">공지사항 목록 로딩 중...</p>

    <table id="notices-table">
        <thead>
            <tr>
                <th>단과대</th>
                <th>제목 (링크)</th>
                <th>대분류</th>
                <th>지원자격 (추출/저장)</th>
                <th>적합도 비교 (테스트)</th>
            </tr>
        </thead>
        <tbody id="notices-body">
            </tbody>
    </table>

    <script>
        // --- [유지] 샘플 프로필 ---
        const SAMPLE_USER_PROFILE = {
            "id": "sample_user_01",
            "major": "컴퓨터과학과",
            "grade": 3, 
            "gpa": 3.8,
            "gpa_scale": 4.5,
            "income_bracket": 8, 
            "language_scores": {
                "TOEIC": 850,
                "OPIC": "IM3"
            },
            "keywords": ["#AI", "#데이터"],
            "gender": "male",
            "military_service": "completed" 
        };
        
        // --- [유지] 한글 번역 헬퍼 ---
        const KOREAN_LABELS = {
            'ELIGIBLE': '✅ 적합',
            'BORDERLINE': '⚠️ 경계',
            'INELIGIBLE': '❌ 부적합',
            'ERROR': '오류'
        };

        document.addEventListener('DOMContentLoaded', loadNotices);

        // 1. 공지사항 목록 로드
        async function loadNotices() {
            try {
                const response = await fetch('/admin/api/notices?limit=1000&sort_by=recent');
                if (!response.ok) throw new Error('Failed to fetch notices');
                
                const data = await response.json();
                const tbody = document.getElementById('notices-body');
                tbody.innerHTML = ''; 

                if (data.items.length === 0) {
                     document.getElementById('loading').textContent = '최근 공지가 없습니다. (#일반 제외)';
                     return;
                }

                window.noticeDataStore = {};
                data.items.forEach(notice => {
                    window.noticeDataStore[notice.id] = notice;
                });

                data.items.forEach(notice => {
                    const tr = document.createElement('tr');
                    
                    const savedQual = notice.ai_extracted_json; 
                    const hasSavedQual = savedQual && !savedQual.error;
                    
                    const qualButtonText = hasSavedQual ? '재추출' : '추출 실행';
                    const qualButtonColor = hasSavedQual ? '#ffc107' : '#17a2b8';
                    
                    let savedQualHtml = '';
                    if (hasSavedQual) {
                        savedQualHtml = `<pre>${escapeHTML(JSON.stringify(savedQual, null, 2))}</pre>`;
                    } else if (savedQual && savedQual.error) {
                         savedQualHtml = `<pre style="color: red;">(저장된 오류: ${escapeHTML(JSON.stringify(savedQual, null, 2))})</pre>`;
                    } else {
                        savedQualHtml = `<pre>(추출된 내용 없음)</pre>`;
                    }
                    
                    // --- [유지] 날짜 표시 HTML 생성 ---
                    const startDateHtml = `<span class="date-display start-date">시작: ${formatDate(notice.start_at_ai)}</span>`;
                    const endDateHtml = `<span class="date-display end-date">마감: ${formatDate(notice.end_at_ai)}</span>`;
                    // ---------------------------------

                    tr.innerHTML = `
                        <td>${escapeHTML(notice.college_name)}</td>
                        <td><a href="${escapeHTML(notice.url)}" target="_blank" title="${escapeHTML(notice.url)}">${escapeHTML(notice.title)}</a></td>
                        <td>${escapeHTML(notice.category_ai)}</td>
                        
                        <td id="cell-qual-${notice.id}">
                            <button class="extract-qual" style="background-color: ${qualButtonColor};" onclick="extractQualifications('${notice.id}', '${notice.category_ai}', this)">
                                ${qualButtonText}
                            </button>
                            
                            <button class="extract-dates" onclick="extractDates('${notice.id}', this)" title="저장된 JSON에서 날짜만 다시 추출/저장">
                                날짜 추출
                            </button>

                            ${startDateHtml} ${endDateHtml}   ${savedQualHtml}  </td>
                        
                        <td id="cell-compare-${notice.id}">
                            <button class="compare" onclick="compareSuitability('${notice.id}', this)">
                                비교 (샘플 프로필)
                            </button>
                            <span class="result-span"></span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('loading').textContent = `공지 ${data.items.length}개 로드 완료. (#일반 제외)`;

            } catch (error) {
                console.error('Error loading notices:', error);
                document.getElementById('loading').textContent = '공지 로드 실패.';
            }
        }

        // 2. [수정] 지원자격(JSON) 추출 [날짜 로직 제거됨]
        async function extractQualifications(noticeId, mainCategory, buttonEl) {
            const cell = buttonEl.closest('td');
            const preEl = cell.querySelector('pre');
            
            buttonEl.disabled = true;
            buttonEl.textContent = '추출 중...';
            preEl.textContent = '(AI 추출 중...)';
            preEl.style.color = '#333';
            
            // [제거] 날짜 Span 업데이트 로직 제거

            try {
                const response = await fetch('/admin/api/extract-qualifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        notice_id: noticeId,
                        main_category: mainCategory
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || '추출 실패');
                }

                // [수정] 응답에 JSON만 포함됨
                const data = await response.json(); 
                
                if (data.ai_extracted_json && !data.ai_extracted_json.error) {
                    // JSON UI 업데이트
                    preEl.textContent = escapeHTML(JSON.stringify(data.ai_extracted_json, null, 2));
                    
                    // [제거] 날짜 UI 업데이트 로직 제거
                    
                    // [중요] 캐시에 JSON만 업데이트
                    if(window.noticeDataStore[noticeId]) {
                        window.noticeDataStore[noticeId].ai_extracted_json = data.ai_extracted_json;
                        // [제거] 날짜 캐시 업데이트 로직 제거
                    }
                    
                    buttonEl.textContent = '재추출';
                    buttonEl.style.backgroundColor = '#28a745'; // 성공 시 초록색
                    
                } else {
                    // 오류 케이스
                    preEl.textContent = `[추출 결과 없음 또는 오류]:\n${escapeHTML(JSON.stringify(data.ai_extracted_json, null, 2))}`;
                    preEl.style.color = 'red';
                    
                    // [제거] 날짜 UI 업데이트 로직 제거

                    // 오류 캐시 업데이트
                    if(window.noticeDataStore[noticeId]) {
                        window.noticeDataStore[noticeId].ai_extracted_json = data.ai_extracted_json || {"error": "Unknown extraction error"};
                        // [제거] 날짜 캐시 업데이트 로직 제거
                    }
                    
                    buttonEl.textContent = '재추출';
                    buttonEl.style.backgroundColor = '#ffc107'; 
                }
                
                buttonEl.disabled = false;

            } catch (error) {
                console.error('Error extracting qualifications:', error);
                preEl.textContent = `[API 오류: ${error.message}]`;
                preEl.style.color = 'red';
                // [제거] 날짜 UI 오류 처리 제거
                
                buttonEl.textContent = '추출 실패';
                buttonEl.style.backgroundColor = '#dc3545'; // 실패 시 빨간색
                buttonEl.disabled = false;
            }
        }

        // 3. [신규] 날짜만 추출 (기존 JSON 기반)
        async function extractDates(noticeId, buttonEl) {
            const cell = buttonEl.closest('td');
            const startDateSpan = cell.querySelector('.start-date');
            const endDateSpan = cell.querySelector('.end-date');

            // [중요] 캐시된 JSON 데이터 확인
            const noticeData = window.noticeDataStore[noticeId];
            if (!noticeData || !noticeData.ai_extracted_json || (noticeData.ai_extracted_json && noticeData.ai_extracted_json.error)) {
                startDateSpan.textContent = '시작: (JSON 없음)';
                endDateSpan.textContent = '마감: (Qual 추출 필요)';
                startDateSpan.style.color = '#dc3545';
                endDateSpan.style.color = '#dc3545';
                return;
            }

            buttonEl.disabled = true;
            buttonEl.textContent = '날짜 추출 중...';
            startDateSpan.textContent = '시작: (날짜 추출 중...)';
            endDateSpan.textContent = '마감: (날짜 추출 중...)';
            startDateSpan.style.color = '#fd7e14'; // loading color
            endDateSpan.style.color = '#fd7e14';

            try {
                // [신규] /api/extract-dates 호출
                const response = await fetch('/admin/api/extract-dates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        notice_id: noticeId
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || '날짜 추출 실패');
                }

                // 응답 (data.start_at_ai, data.end_at_ai)
                const data = await response.json(); 
                
                // 날짜 UI 업데이트
                startDateSpan.textContent = `시작: ${formatDate(data.start_at_ai)}`;
                endDateSpan.textContent = `마감: ${formatDate(data.end_at_ai)}`;
                startDateSpan.style.color = '#27ae60'; // reset color
                endDateSpan.style.color = '#c0392b'; // reset color

                // 날짜 캐시 업데이트
                if(window.noticeDataStore[noticeId]) {
                    window.noticeDataStore[noticeId].start_at_ai = data.start_at_ai;
                    window.noticeDataStore[noticeId].end_at_ai = data.end_at_ai;
                }
                
                buttonEl.textContent = '날짜 추출됨';
                buttonEl.style.backgroundColor = '#28a745'; // Green
                buttonEl.disabled = false;

            } catch (error) {
                console.error('Error extracting dates:', error);
                startDateSpan.textContent = `시작: (API 오류)`;
                endDateSpan.textContent = `마감: (추출 실패)`;
                startDateSpan.style.color = '#dc3545';
                endDateSpan.style.color = '#dc3545';
                buttonEl.textContent = '날짜 추출 실패';
                buttonEl.style.backgroundColor = '#dc3545'; // Red
                buttonEl.disabled = false;
            }
        }


        // 4. [유지] 적합도 비교 (기존 3번)
        async function compareSuitability(noticeId, buttonEl) {
            // ... (기존 compareSuitability 함수 내용은 변경 없음) ...
            const cell = buttonEl.closest('td');
            const resultSpan = cell.querySelector('.result-span');
            
            const noticeData = window.noticeDataStore[noticeId];
            
            if (!noticeData || !noticeData.ai_extracted_json || (noticeData.ai_extracted_json && noticeData.ai_extracted_json.error)) {
                resultSpan.textContent = '[오류: 먼저 지원자격을 성공적으로 추출해야 합니다.]';
                resultSpan.className = 'result-span error';
                return;
            }

            buttonEl.disabled = true;
            buttonEl.textContent = '비교 중...';
            resultSpan.textContent = '(comparison_logic.py 실행 중...)';
            resultSpan.className = 'result-span loading';

            try {
                const response = await fetch('/admin/api/compare-notice', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    
                    body: JSON.stringify({
                        notice_json: noticeData, 
                        user_profile: SAMPLE_USER_PROFILE
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.detail || '비교 실패');
                }

                const data = await response.json();
                
                const eligibility = data.eligibility || 'ERROR';
                const eligibility_korean = KOREAN_LABELS[eligibility] || eligibility; 

                const results = data.criteria_results || {};
                const passItems = results.pass || [];
                const failItems = results.fail || [];
                const verifyItems = results.verify || [];

                const toLi = (item) => `<li style="font-size: 0.9em; margin-top: 3px;">${escapeHTML(item)}</li>`;
                const listStyle = `style="margin: 5px 0 10px 0; padding-left: 20px;"`;

                let html = `<strong>[${eligibility_korean}]</strong>`; 
                
                if (passItems.length > 0) {
                    html += `
                        <strong style="color: #28a745; display: block; margin-top: 8px;">✅ 만족 조건:</strong>
                        <ul ${listStyle}>${passItems.map(toLi).join('')}</ul>
                    `;
                }
                
                if (failItems.length > 0) {
                     html += `
                        <strong style="color: #dc3545; display: block; margin-top: 8px;">❌ 미충족 조건:</strong>
                        <ul ${listStyle}>${failItems.map(toLi).join('')}</ul>
                    `;
                }
                
                if (verifyItems.length > 0) {
                     html += `
                        <strong style="color: #fd7e14; display: block; margin-top: 8px;">⚠️ 확인 필요:</strong>
                        <ul ${listStyle}>${verifyItems.map(toLi).join('')}</ul>
                    `;
                }

                resultSpan.innerHTML = html;
                resultSpan.className = `result-span ${eligibility.toLowerCase()}`; 
                
                buttonEl.textContent = '비교 (샘플 프로필)';
                buttonEl.disabled = false;

            } catch (error) {
                console.error('Error comparing suitability:', error);
                resultSpan.textContent = `[API 오류: ${error.message}]`;
                resultSpan.className = 'result-span error';
                buttonEl.textContent = '비교 실패';
                buttonEl.style.backgroundColor = '#dc3545';
                buttonEl.disabled = false;
            }
        }

        // --- [유지] (Helper) 날짜 포맷팅 ---
        function formatDate(isoString) {
            if (!isoString) return 'N/A';
            try {
                const date = new Date(isoString);
                if (isNaN(date.getTime())) {
                    return 'Invalid Date';
                }
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            } catch(e) {
                console.warn(`formatDate error for: ${isoString}`, e);
                return 'Parse Error';
            }
        }

        // (Helper) HTML 태그 이스케이프
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            if (typeof str === 'object') str = JSON.stringify(str, null, 2);
            
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }
    </script>
</body>
</html>